-- Find the total number of tracks available in the music store. 
select 
distinct count(*) 
from music.track; 

 

-- Retrieve the top 10 most expensive tracks. 

select 

name 

from music.track 

order by unit_price desc 

limit 10;  

 

-- Count the number of customers in each country. 

select 

country,  

count(distinct customer_id) as customer_count 

from music.customer 

group by country 

order by 2 desc; 

 

-- Display the total number of invoices generated in every year. 

select 

extract(year from invoice_date) as year, 

count(distinct invoice_id) as invoice_count 

from music.invoice 

group by extract(year from invoice_date)  

order by 1 asc; 

 

-- Identify the top 5 customers who generated the highest total revenue. 

select 

c.customer_id, 

c.first_name, 

c.last_name, 

c.country, 

round(sum(i.total),2) as total_revenue 

from music.customer as c 

join music.invoice as i 

on(c.customer_id = i.customer_id) 

group by 1, 2, 3, 4 

order by 5 desc 

limit 5; 

 

-- Determine the most popular music genre based on number of purchases. 

select  

g.name, 

count(il.invoice_id) as invoice_count 

from music.invoice_line as il 

join music.track as t 

on(il.track_id = t.track_id) 

join music.genre as g 

on(t.genre_id = g.genre_id) 

group by g.name  

order by 2 desc; 

-- Find total revenue generated from each country. 

select  

billing_country, 

round(sum(total),2) as total_revenue 

from music.invoice 

group by 1 

order by 2 desc 

limit 10;  

 

-- Retrieve best-selling artists by total sales amount. 

select 

art.name, 

round(sum(i.total),2) as total_sales 

from music.invoice as i 

join music.invoice_line as il 

on(i.invoice_id = il.invoice_id) 

join music.track as t 

on(il.track_id = t.track_id) 

join music.album as a 

on(t.album_id = a.album_id) 

join music.artist as art 

on(a.artist_id = art.artist_id) 

group by 1 

order by 2 desc 

limit 10; 

 

-- Find the average invoice amount per customer country. 

select  

billing_country, 

round((sum(total) / count(customer_id)),2) as average_invoice 

from music.invoice 

group by 1 

order by 2 desc;  

 

-- Which genres are most popular among customers from India? 

select 

g.name, 

count(*) as sales_count 

from music.invoice as i 

join music.invoice_line as il 

on(i.invoice_id = il.invoice_id) 

join music.track as t 

on(t.track_id = il.track_id) 

join music.genre as g 

on(g.genre_id = t.genre_id) 

where billing_country = 'India' 

group by 1 

order by 2 desc; 

 

-- Identify the top 3 artists by revenue in every genre. 

with genre_artist_revenue as ( 

select 

g.name as genre, 

art.name as artist, 

round(sum(i.total),2) as total_revenue, 

dense_rank() over(partition by g.name order by sum(i.total) desc) as ranked 

from music.invoice as i  

join music.invoice_line as il  

on(i.invoice_id = il.invoice_id)  

join music.track as t  

on(il.track_id = t.track_id)  

join music.album as a  

on(t.album_id = a.album_id)  

join music.artist as art  

on(a.artist_id = art.artist_id) 

join music.genre as g 

on(g.genre_id = t.genre_id) 

group by 1, 2) 

 

select  

genre,  

artist, 

total_revenue 

from genre_artist_revenue 

where ranked <= 3 

order by 1, ranked; 

 

-- Compute sales seasonality — peak and drop months & whether it repeats yearly. 

select 

format_timestamp('%Y', invoice_date) as year, 

format_timestamp('%m', invoice_date) as month, 

round(sum(total),2) as total_revenue 

from music.invoice 

group by 1, 2 

order by 3 desc; 

 

-- Calculate repeat purchase rate (customers with >1 invoice) 

select  

round((sum(invoice_count) / count(*)),2) as purchase_rate 

from ( 

select 

customer_id, 

count (invoice_id) as invoice_count 

from music.invoice 

group by customer_id) as customer_invoice_count_table; 

 

-- Find "revenue leakage" countries — high number of customers but low average spending. 

select  

c.country, 

round((sum(i.total) / count(c.customer_id)),2) as revenue_per_customer 

from music.customer as c 

join music.invoice as i 

on(c.customer_id = i.customer_id) 

group by 1 

order by 2 asc; 

 

-- Find the genres that first-time customers usually start with (entry genre funnel). 

with customer_first_genre as ( 

select 

i.customer_id, 

g.name, 

dense_rank() over(partition by i.customer_id order by i.invoice_date) as ranked, 

i.invoice_date 

from music.invoice as i 

join music.invoice_line as il 

on(i.invoice_id = il.invoice_id) 

join music.track as t 

on(t.track_id = il.track_id) 

join music.genre as g 

on(g.genre_id = t.genre_id) 

) 

 

select 

name, 

count(*) as frequency_count 

from customer_first_genre 

where ranked = 1 

group by 1 

order by 2 desc 

limit 5; 
